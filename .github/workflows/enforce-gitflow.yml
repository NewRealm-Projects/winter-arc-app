#
# Enforce Git-Flow Model
#
# Purpose: Ensure only develop → main PRs are allowed
# This workflow blocks PRs from feature branches directly to main
#

name: Enforce Git-Flow

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  issues: write

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # ENFORCE DEVELOP → MAIN ONLY
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  enforce-develop-to-main:
    name: Enforce develop → main
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check source branch
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseBranch = pr.base.ref;
            const headBranch = pr.head.ref;

            console.log(`PR: ${headBranch} → ${baseBranch}`);

            // Only enforce on PRs to main
            if (baseBranch !== 'main') {
              console.log('✅ Not targeting main, allowing PR');
              return;
            }

            // Allow only from develop branch
            if (headBranch === 'develop') {
              console.log('✅ PR from develop → main: ALLOWED');
              return;
            }

            // Block all other branches
            console.log(`❌ PR from ${headBranch} → main: BLOCKED`);

            // Add comment explaining the policy
            const comment = `## ❌ Git-Flow Policy Violation

            This PR is **blocked** because it violates the Git-Flow model.

            ### 📋 Current PR
            - Source: \`${headBranch}\`
            - Target: \`${baseBranch}\`

            ### ✅ Required Flow
            1. Feature branches must merge to \`develop\` first
            2. Only \`develop\` can merge to \`main\`

            ### 🔧 How to fix

            #### Option 1: Merge to develop first (recommended)
            \`\`\`bash
            # Close this PR
            # Create new PR: ${headBranch} → develop
            gh pr create --base develop --head ${headBranch}
            \`\`\`

            #### Option 2: Cherry-pick to develop
            \`\`\`bash
            git checkout develop
            git pull origin develop
            git cherry-pick <commit-sha>
            git push origin develop
            # Then create PR: develop → main
            \`\`\`

            ### 📖 Documentation
            See [Branch Protection Guide](.github/BRANCH_PROTECTION.md) for details.

            ---
            **This is an automated check. Contact DevOps if you need an exception.**`;

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const existingComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Git-Flow Policy Violation')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment,
              });
            }

            // Fail the check
            core.setFailed(`❌ Only PRs from develop → main are allowed. Current: ${headBranch} → main`);

      - name: Success message
        if: success()
        run: |
          echo "✅ Git-Flow policy check passed"
          echo "PR is from develop → main"
